================================================================================
Lots of Knobs - コンパクトMIDIコントローラ
================================================================================

【コンセプト】
"This is the greatest and smallest MIDI controller."

キースイッチとロータリエンコーダを組み合わせた、直感的な操作が可能な
超コンパクトMIDIコントローラ。ボタンを押しながらエンコーダを回すことで、
複数のMIDIパラメータを素早く、視覚的フィードバックを得ながら操作できます。

================================================================================
【主要機能】
================================================================================

■ メイン機能: エンコーダベースのMIDI CC制御
  - ボタンを押しながらエンコーダを回す → 対応するMIDI CCの値を変更
  - 複数ボタンの同時押しに対応 → 複数パラメータを同時に操作可能
  - 各ボタン下のLEDで現在のCC値を視覚的に表示

■ MIDI Noteモード
  - ボタンを押すとMIDI Noteを送信
  - パフォーマンスやトリガーとして使用可能

■ レイヤー機能
  - key16（専用レイヤーボタン）を使った多層構造
  - レイヤーボタン + 他のキー → レイヤー切り替え
  - 16ボタン × 複数レイヤーで多くのパラメータをコントロール

■ 柔軟な設定
  - 設定メニューによるボタン役割の変更（CC / Note / Function）
  - MIDI CCナンバーの自由な割り当て
  - MIDI チャンネル設定

■ シーケンサ機能（将来実装予定）
  - MIDI CCオートメーションの記録・再生
  - ステップシーケンサ機能

■ 多様なMIDI出力
  - USB MIDI（RP2040 USB経由）
  - TRS MIDI OUT（ハードウェアジャック）
  - 両方同時出力にも対応

■ ビジュアルフィードバック
  - WS2812C LED × 16個: パラメータ値を色や明るさで表現
  - OLED ディスプレイ: 現在のレイヤー、モード、パラメータ名などを表示

================================================================================
【基本構成】
================================================================================

- マイコンボード: RP2040-Zero
- 開発環境: CircuitPython
- サイズ: 超コンパクト（詳細は回路図参照）

================================================================================
【ハードウェアコンポーネント】
================================================================================

1. 入力デバイス
   - キースイッチ: 17個 (key0～key16)
     * key0～key15: パラメータ/Note用（各LEDバックライト付き）
     * key16: レイヤー専用ボタン（LEDなし）
   - ロータリエンコーダ: 1個 (プッシュボタン付き)
     - A相: CLK (GP4)
     - B相: DT (GP1)
     - スイッチ: SW（マトリックス接続）

2. 出力デバイス
   - OLEDディスプレイ: 128×64 0.96インチ (I2C接続、縦長配置)
   - MIDI出力: TRSジャック（GP27）
   - USB MIDI: RP2040内蔵USB経由
   - WS2812C-2020 LED: 16個
     * key0～key15の各スイッチ下に配置
     * key16にはLED無し
     * LED0→LED1→...→LED15 とカスケード接続
     * データ信号はBSS138で3.3V→5Vに変換

================================================================================
【使用例】
================================================================================

例1: シンセパラメータのリアルタイム操作
  - レイヤー1: フィルター系（Cutoff, Resonance, Envelope...）
  - レイヤー2: オシレーター系（Detune, PWM, Wave shape...）
  - レイヤー3: エフェクト系（Reverb, Delay, Chorus...）
  → ボタン押しながらエンコーダでパラメータを直感的に調整

例2: ライブパフォーマンス
  - 複数ボタン同時押し + エンコーダで複数エフェクトを同時操作
  - LEDの明るさでパラメータ値を視覚的に確認
  - Note モードでドラムトリガーやサンプル再生

例3: DAWコントロール
  - ミキサーのボリューム/パンを各ボタンに割り当て
  - 複数トラックを同時に調整

================================================================================
【GPIO接続マップ】
================================================================================

ピン番号 | 機能            | 説明
---------|----------------|--------------------------------------------------
GP0      | (未使用)        | -
GP1      | ENCODER_DT      | ロータリエンコーダ B相
GP2      | (未使用)        | -
GP3      | (未使用)        | -
GP4      | ENCODER_CLK     | ロータリエンコーダ A相
GP5      | MATRIX_COL0     | キーマトリックス列0 (key0, 4, 8, 12)
GP6      | LED_DATA        | WS2812C-2020データ (BSS138経由で5Vに変換)
GP7      | MATRIX_COL1     | キーマトリックス列1 (key1, 5, 9, 13)
GP8      | MATRIX_ROW0     | キーマトリックス行0 (key0-3, エンコーダSW)
GP9      | MATRIX_COL2     | キーマトリックス列2 (key2, 6, 10, 14)
GP10     | MATRIX_ROW1     | キーマトリックス行1 (key4-7)
GP11     | MATRIX_COL3     | キーマトリックス列3 (key3, 7, 11, 15)
GP12     | I2C_SDA         | OLEDディスプレイ SDA
GP13     | I2C_SCL         | OLEDディスプレイ SCL
GP14     | MATRIX_ROW2     | キーマトリックス行2 (key8-11)
GP15     | MATRIX_COL4     | キーマトリックス列4 (key16, エンコーダSW)
GP26     | MATRIX_ROW3     | キーマトリックス行3 (key12-15, key16)
GP27     | MIDI_TX         | MIDI送信 (TRSジャックのTピン)
GP28     | (未使用)        | -
GP29     | (未使用)        | -
GP30     | +3V3            | 電源
GP31     | GND             | グランド
GP32     | +5V             | 電源

================================================================================
【キーマトリックス構造】
================================================================================

マトリックス配置 (4行 × 5列):

          COL0(GP5)  COL1(GP7)  COL2(GP9)  COL3(GP11)  COL4(GP15)
          ---------------------------------------------------------
ROW0(GP8)  | key0    | key1    | key2    | key3     | encoder_SW |
ROW1(GP10) | key4    | key5    | key6    | key7     | -          |
ROW2(GP14) | key8    | key9    | key10   | key11    | -          |
ROW3(GP26) | key12   | key13   | key14   | key15    | key16      |

※ ロータリエンコーダのスイッチは ROW0 と COL4 の交点に配置
※ key16 はレイヤー専用ボタン（LEDなし）

================================================================================
【LED配置】
================================================================================

LED番号と対応キースイッチ（蛇行配線）:

【重要】LEDのデータラインは蛇行配線されています！
キースイッチの物理配置とLEDインデックスが異なります。

キースイッチ物理配置:
  key0   key1   key2   key3    (ROW0)
  key4   key5   key6   key7    (ROW1)
  key8   key9   key10  key11   (ROW2)
  key12  key13  key14  key15   (ROW3)
  [key16]                      (レイヤーボタン - LEDなし)

LEDデータライン順序（GP6から）:
  LED3   LED2   LED1   LED0    ← (右から左)
  LED4   LED5   LED6   LED7    → (左から右)
  LED11  LED10  LED9   LED8    ← (右から左)
  LED12  LED13  LED14  LED15   → (左から右)

対応表:
  key0  → LED3      key4  → LED4      key8  → LED11     key12 → LED12
  key1  → LED2      key5  → LED5      key9  → LED10     key13 → LED13
  key2  → LED1      key6  → LED6      key10 → LED9      key14 → LED14
  key3  → LED0      key7  → LED7      key11 → LED8      key15 → LED15

※ key16 にはLEDなし
※ LED接続順序: GP6 → LED0 → LED1 → ... → LED15 (蛇行カスケード接続)

LED表示仕様:
  - MIDI CC値（0-127）をLEDの明るさと色で表現（予定）
    * 色相: 値に応じて青→緑→黄→赤などのグラデーション
    * 明るさ: 値が高いほど明るく
  - ボタン押下時の視覚的フィードバック
  ※ 最適な表現方法は実装時にテストして決定

================================================================================
【ロータリエンコーダ】
================================================================================

- CLK (A相): GP4
- DT (B相):  GP1
- スイッチ:  ROW0(GP8) と COL4(GP15) の交点

回転検出: CLKとDTの位相差で回転方向を判定
- 時計回り:   CLKがHigh→Lowの時、DTがHigh
- 反時計回り: CLKがHigh→Lowの時、DTがLow

使用用途:
- ボタン押下中: 対応するMIDI CCの値を増減
- ボタン非押下: グローバル機能（音量、テンポなど）
- プッシュボタン: 設定メニューの呼び出し、Enter操作など

================================================================================
【MIDI出力】
================================================================================

1. TRS MIDI OUT（ハードウェア）
   - TX: GP27 (UARTでMIDIメッセージ送信)
   - ボーレート: 31250 bps (MIDI規格)
   - 接続: TRSジャックのTピン

2. USB MIDI
   - RP2040内蔵USB機能を使用
   - PCやDAWに直接接続可能
   - ドライバ不要（クラスコンプライアント）

※ 両方の出力を同時に使用可能

================================================================================
【OLEDディスプレイ】
================================================================================

- 物理解像度: 128×64（0.96インチ）
- 配置: 90度回転（縦長配置）
- 表示領域: 64(幅) × 128(高さ) ピクセル
- 通信方式: I2C
- SDA: GP12
- SCL: GP13

表示内容:
  - 現在のレイヤー番号・名前
  - 現在のモード（CC / Note / Function）
  - 選択中のパラメータ名とCC値・MIDIチャンネル
  - 設定メニュー
  - シーケンサ情報（将来実装）

※ 縦長配置のため、テキストやUIは縦方向を活用した設計

================================================================================
【電源】
================================================================================

- メイン電源: 3.3V (GP30)
- LED用電源: 5V (GP32) ※WS2812C-2020用
- 信号レベル変換: BSS138 (3.3V→5V) ※LEDデータライン用
- グランド: GP31
- 給電方法: USB Type-C（RP2040-Zero）

消費電力:
  - 通常動作: 約XXX mA（測定予定）
  - LED全点灯時: 約XXX mA（測定予定）

================================================================================
【開発ロードマップ】
================================================================================

■ Phase 1: 基本機能実装 【優先度: 高】
  [1-1] ハードウェアテスト ✓
    ✓ OLED動作確認
    ✓ TRS MIDI OUT配線確認
    ✓ LED点灯確認（予定）
    ✓ キーマトリックス動作確認（予定）
    ✓ エンコーダ動作確認（予定）

  [1-2] 基本入力処理
    □ キーマトリックススキャン実装
      - チャタリング対策
      - 同時押し検出（最大16キー）
      - キーイベント管理（Press/Release/Hold）
    □ ロータリエンコーダ読み取り
      - 回転方向検出
      - プッシュボタン処理
      - 加速度対応（高速回転時の値変化量調整）

  [1-3] 基本出力処理
    □ WS2812C LED制御
      - 蛇行配線対応のマッピング実装
      - 個別LED制御
      - 明るさ制御
    □ TRS MIDI OUT送信
      - UART初期化（31250 bps）
      - MIDI Note On/Off
      - MIDI CC送信
    □ USB MIDI送信
      - USB MIDI初期化
      - Note/CC送信

  [1-4] OLEDディスプレイ基本表示
    □ 初期化と基本描画
    □ レイヤー情報表示
    □ パラメータ名・値表示

■ Phase 2: コア機能実装 【優先度: 高】
  [2-1] MIDI CCモード
    □ ボタン押下 + エンコーダでCC値変更
    □ 複数ボタン同時押し対応
    □ LED表示連動（CC値 → 明るさ/色）
    □ CC値の保持と表示

  [2-2] レイヤー機能
    □ レイヤー管理システム
    □ key16（レイヤーボタン）の特殊処理
    □ レイヤー切り替え処理
    □ レイヤーごとのCC/Note設定保存

  [2-3] MIDI Noteモード
    □ ボタン押下でNote On/Off
    □ ベロシティ固定/可変
    □ モード切り替え機能

■ Phase 3: 設定・管理機能 【優先度: 中】
  [3-1] 設定メニュー
    □ エンコーダ（単体）でメニューナビゲーション
    □ エンコーダプッシュでメニュー起動/決定
    □ ボタン機能の設定（CC/Note/Function）
    □ MIDI CCナンバー割り当て（デフォルト値あり）
    □ MIDIチャンネル設定（ボタンごとに個別設定可能）
    □ レイヤー名編集

  [3-2] データ永続化
    □ 設定のフラッシュメモリ保存
    □ 起動時の設定読み込み
    □ 設定のバックアップ/リストア機能

■ Phase 4: 拡張機能 【優先度: 低】
  [4-1] シーケンサ機能
    □ MIDI CCオートメーション記録
    □ オートメーション再生
    □ ステップシーケンサ実装
    □ シーケンスデータの保存/読み込み

  [4-2] 高度なLED表現
    □ アニメーションパターン
    □ CC値のグラデーション表示
    □ カスタムカラー設定

  [4-3] その他
    □ PC用設定エディタ（オプション）
    □ ファームウェアアップデート機能
    □ MIDIクロック同期

■ Phase 5: 最適化・仕上げ 【優先度: 中】
  [5-1] パフォーマンス最適化
    □ レイテンシ削減
    □ 消費電力最適化
    □ メモリ使用量最適化

  [5-2] ユーザビリティ向上
    □ 直感的な操作フロー確立
    □ エラーハンドリング
    □ ヘルプ表示機能

  [5-3] ドキュメント整備
    □ ユーザーマニュアル作成
    □ 開発者ドキュメント
    □ 回路図・基板データ公開

================================================================================
【技術仕様メモ】
================================================================================

MIDI仕様:
  - MIDI 1.0 準拠
  - チャンネル: 1-16（ボタンごとに個別設定可能、デフォルト=1）
  - CC範囲: 0-127（任意のCCナンバーに対応、デフォルト割り当てあり）
  - Note範囲: 0-127
  - ベロシティ: 固定/可変（設定可能）

レイヤー仕様:
  - レイヤー数: 16レイヤー（key0-15に対応）
  - 各レイヤーに16個のパラメータ（各ボタン）を割り当て可能
  - 合計 256 パラメータをコントロール可能
  - メモリ容量次第で調整の可能性あり

LED表示:
  - WS2812C-2020（フルカラーRGB LED）
  - CC値 0-127 を明るさまたは色相で表現
  - リフレッシュレート: XXX Hz（調整予定）

応答性:
  - キースキャンレート: XXX Hz（目標値）
  - エンコーダポーリングレート: XXX Hz（目標値）
  - MIDIレイテンシ: < X ms（目標値）

================================================================================
【開発メモ・TODO】
================================================================================

仕様決定事項:
  ✓ レイヤー数: 16レイヤー（メモリ容量次第で調整可能性あり）
  ✓ MIDIチャンネル: ボタンごとに個別設定可能、デフォルト=1
  ✓ LED表示: 色+明るさの組み合わせで表現（実装時にテスト）
  ✓ エンコーダ単体: メニューナビゲーション用
  ✓ OLED配置: 縦長（90度回転）

要確認・調整事項:
  □ RP2040のメモリ使用量とレイヤー数の関係
  □ CC番号のデフォルト割り当てパターン
  □ LED色相マッピング（CC値0-127 → 色）
  □ エンコーダの加速カーブ
  □ 縦長OLEDのUI設計詳細
  □ シーケンサのデータ構造（Phase 4）

将来的な拡張案:
  - Bluetooth MIDI対応
  - バッテリー駆動対応
  - ケース設計・3Dプリント
  - カスタムファームウェアのWeb公開

================================================================================
【参考資料・リンク】
================================================================================

- CircuitPython公式: https://circuitpython.org/
- RP2040データシート: https://datasheets.raspberrypi.com/rp2040/rp2040-datasheet.pdf
- MIDI規格: https://www.midi.org/specifications
- WS2812Cデータシート: （リンク追加予定）

================================================================================
【ライセンス】
================================================================================

（ライセンス情報は後で追加）

================================================================================
【変更履歴】
================================================================================

2025-10-14: 初版作成 - ハードウェア仕様書とロードマップ追加
2025-XX-XX: （今後の変更をここに記録）

================================================================================
